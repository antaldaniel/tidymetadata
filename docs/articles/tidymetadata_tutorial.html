<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tidymetadata • tidymetadata</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tidymetadata</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/muuankarski/tidymetadata">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>tidymetadata</h1>
            
            <h4 class="date">2017-05-16</h4>
          </div>

    
    
<div class="contents">
<div id="using-tidymetadata-package-with-luxembourdg-income-study-data" class="section level1">
<h1 class="hasAnchor">
<a href="#using-tidymetadata-package-with-luxembourdg-income-study-data" class="anchor"></a>Using tidymetadata-package with Luxembourdg Income Study data</h1>
<p>Install the package with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">"muuankarski/tidymetadata"</span>)</code></pre></div>
<p>Tidymetadata-package provides a technical backbone for <em>tidy metadata</em> logic to work with social survey data using tidyverse tools.</p>
<p>If not familiar with tidy data or tidyverse, please familiarise yourself with:</p>
<ul>
<li><a href="http://vita.had.co.nz/papers/tidy-data.html">Wickham, Hadley. 2014. ‘Tidy Data’. Journal of Statistical Software 59 (10). doi:10.18637/jss.v059.i10.</a></li>
<li><a href="http://r4ds.had.co.nz/tidy-data.html">R for Data Science: Tidy Data</a></li>
<li><a href="http://tidyverse.org/" class="uri">http://tidyverse.org/</a></li>
</ul>
<p>Tidymetadata is not replacement for dedicated packages to work with survey data in general such as <a href="http://r-survey.r-forge.r-project.org/survey/"><code>survey</code></a>, but it complements them by providing a framework to deal with the <em>labelled</em> structure typical for social survey data. Such structure is not optimal to work with in R and tidyverse. Basically, tidymetadata provides functions to <strong>separate</strong> the <strong>data</strong> and <strong>metadata</strong> from <em>labelled</em> data.frame imported in R with <a href="http://haven.tidyverse.org/"><code>haven</code></a> and how to put it back together. This approach comes especially handy when building shiny-applications on top of such data. Try first running the shiny-app wrapped with the package with <code>tidymetadata::runExample()</code>.</p>
<div id="download-spss-stata-and-sas-training-data-from-luxembourg-income-study" class="section level2">
<h2 class="hasAnchor">
<a href="#download-spss-stata-and-sas-training-data-from-luxembourg-income-study" class="anchor"></a>Download SPSS, Stata and SAS training data from Luxembourg Income Study</h2>
<p>Survey datas are in most cases still disseminated in either SAS, SPSS or Stata formats with metadata included in variable and value labels. We first download the <strong>demo</strong> files freely available at from <a href="http://www.lisdatacenter.org/">Luxembourg Income Study</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
if (!<span class="kw">file.exists</span>(<span class="st">"./datasets/data.sav"</span>)){

  <span class="kw">dir.create</span>(<span class="st">"./datasets"</span>)
  <span class="co"># SPSS-file</span>
  <span class="kw">download.file</span>(<span class="st">"http://www.lisdatacenter.org/wp-content/uploads/it04ip.sav"</span>, <span class="st">"./datasets/data.sav"</span>)
  <span class="co"># Stata-file</span>
  <span class="kw">download.file</span>(<span class="st">"http://www.lisdatacenter.org/wp-content/uploads/it04ip.dta"</span>, <span class="st">"./datasets/data.dta"</span>)
  <span class="co"># SAS-file</span>
  <span class="kw">download.file</span>(<span class="st">"http://www.lisdatacenter.org/wp-content/uploads/it04ip.sas7bdat"</span>, <span class="st">"./datasets/data.sas7bdat"</span>)

}</code></pre></div>
<p>Package <a href="http://haven.tidyverse.org/"><code>haven</code></a> provides handy functions for reading in such formats</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(haven)
spss  &lt;-<span class="st"> </span><span class="kw">read_sav</span>(<span class="st">"./datasets/data.sav"</span>)
stata &lt;-<span class="st"> </span><span class="kw">read_dta</span>(<span class="st">"./datasets/data.dta"</span>)
sas   &lt;-<span class="st"> </span><span class="kw">read_sas</span>(<span class="st">"./datasets/data.sas7bdat"</span>)</code></pre></div>
<p>They all have the same number of cases and variables, and seem to share similar structure with variable labels and value labels as attributes. However, when applying <code>str()</code> function for all three datas we can spot that imported spss and stata files seem to have identical structure and somewhat richer than sas file has.</p>
</div>
<div id="create-tidy-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#create-tidy-metadata" class="anchor"></a>Create “tidy metadata”</h2>
<p>Once we have datafiles in R, we use function <code>tidymetadata::create_meta()</code> to create tidy metadata. <code>tidymetadata::create_meta()</code> extracts the metadata information from variable attributes and creates a tidy data frame with columns:</p>
<ul>
<li>
<code>code</code> for variable code</li>
<li>
<code>name</code> for variable name</li>
<li>
<code>value</code> for each value for each labelled variable</li>
<li>
<code>label</code> for each value label for each labelled variable</li>
<li>
<code>class</code> for wheter the variable in question is <code>factor</code>, <code>numeric</code> or <code>character</code>
</li>
</ul>
<p><strong>As for rows</strong>, tidy metadata has a single row for a unique <code>numeric</code> or <code>character</code> type of variable. Such variables are not labelled ie. have no additional information within the object. As for <code>factor</code> variables, tidy metadata has <strong>one row per one value ie. factor level</strong>. For instance, two class <em>gender</em> variable would have two rows in tidy metadata, one for both values.</p>
<p>Lets apply the <code>tidymetadata::create_meta()</code>-function for each data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidymetadata)
meta_spss &lt;-<span class="st"> </span><span class="kw">create_metadata</span>(spss)
meta_stata &lt;-<span class="st"> </span><span class="kw">create_metadata</span>(stata)
meta_sas &lt;-<span class="st"> </span><span class="kw">create_metadata</span>(sas)</code></pre></div>
<p>And, lets subset each data into variable <code>sex</code> and pile up the resulting rows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meta_spss$type =<span class="st">"spss"</span>
meta_stata$type =<span class="st">"stata"</span>
meta_sas$type =<span class="st">"sas"</span>

<span class="kw">bind_rows</span>(
          meta_spss[meta_spss$code ==<span class="st"> "sex"</span>,],
          meta_stata[meta_stata$code ==<span class="st"> "sex"</span>,],
          meta_sas[meta_sas$code ==<span class="st"> "sex"</span>,]
          ) %&gt;%<span class="st"> </span>
<span class="st">  </span>knitr::<span class="kw">kable</span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">code</th>
<th align="left">name</th>
<th align="left">label</th>
<th align="right">value</th>
<th align="left">class</th>
<th align="left">type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[1]male</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[2]female</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[1]male</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">stata</td>
</tr>
<tr class="even">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[2]female</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">stata</td>
</tr>
<tr class="odd">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">numeric</td>
<td align="left">sas</td>
</tr>
</tbody>
</table>
<p>We can see that SPSS and Stata files produce identical metadatas for variable <code>sex</code>, but SAS file is lacking the value label information. For this reason we should work only using either Stata or SPSS files in this case, and for this particular vignette we will choose the SPSS file.</p>
</div>
<div id="stripping-data-from-attributes" class="section level2">
<h2 class="hasAnchor">
<a href="#stripping-data-from-attributes" class="anchor"></a>Stripping data from attributes</h2>
<p>Once we have extracted the metadata information from the labelled data, we can strip off this information and leave only the bare data with <code>numeric/character</code> content in the variables using <code>tidymetadata::strip_attributes()</code> function with no attributes whatsoever.</p>
<p>Before stripping the attributes we get:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(spss[,<span class="dv">1</span>:<span class="dv">10</span>])</code></pre></div>
<pre><code>## Classes 'tbl_df', 'tbl' and 'data.frame':    1358 obs. of  10 variables:
##  $ hid    : atomic  1 1 2 2 2 2 3 4 4 4 ...
##   ..- attr(*, "label")= chr "unique unit identifier"
##   ..- attr(*, "format.spss")= chr "F9.0"
##  $ pid    : atomic  1 2 1 2 3 4 1 1 2 3 ...
##   ..- attr(*, "label")= chr "person identifier"
##   ..- attr(*, "format.spss")= chr "F8.0"
##  $ did    : atomic  198 198 198 198 198 198 198 198 198 198 ...
##   ..- attr(*, "label")= chr "unique country/year number"
##   ..- attr(*, "format.spss")= chr "F8.0"
##  $ dname  : atomic  it04 it04 it04 it04 ...
##   ..- attr(*, "label")= chr "country/year identifier"
##   ..- attr(*, "format.spss")= chr "A4"
##  $ cname  : atomic  Italy Italy Italy Italy ...
##   ..- attr(*, "label")= chr "country name"
##   ..- attr(*, "format.spss")= chr "A5"
##  $ iso2   : atomic  it it it it ...
##   ..- attr(*, "label")= chr "2-letter country abbreviation"
##   ..- attr(*, "format.spss")= chr "A2"
##  $ year   : atomic  2004 2004 2004 2004 2004 ...
##   ..- attr(*, "label")= chr "reference year"
##   ..- attr(*, "format.spss")= chr "F8.0"
##  $ wave   :Class 'labelled'  atomic [1:1358] 6 6 6 6 6 6 6 6 6 6 ...
##   .. ..- attr(*, "label")= chr "data wave"
##   .. ..- attr(*, "format.spss")= chr "F18.0"
##   .. ..- attr(*, "labels")= Named num [1:10] 0 1 2 3 4 5 6 7 8 9
##   .. .. ..- attr(*, "names")= chr [1:10] "[0]Historical Wave" "[1]Wave I" "[2]Wave II" "[3]Wave III" ...
##  $ pwgt   : atomic  3.7 3.7 8.9 8.9 8.9 ...
##   ..- attr(*, "label")= chr "person weight (normalised)"
##   ..- attr(*, "format.spss")= chr "F8.2"
##  $ ppopwgt: atomic  21820 21820 52526 52526 52526 ...
##   ..- attr(*, "label")= chr "person weight (inflated)"
##   ..- attr(*, "format.spss")= chr "F8.2"</code></pre>
<p>And after removing attributes the output for same columns is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove_attributes</span>
data_spss &lt;-<span class="st"> </span>tidymetadata::<span class="kw">strip_attributes</span>(spss)
<span class="kw">str</span>(data_spss[,<span class="dv">1</span>:<span class="dv">10</span>])</code></pre></div>
<pre><code>## Classes 'tbl_df', 'tbl' and 'data.frame':    1358 obs. of  10 variables:
##  $ hid    : num  1 1 2 2 2 2 3 4 4 4 ...
##  $ pid    : num  1 2 1 2 3 4 1 1 2 3 ...
##  $ did    : num  198 198 198 198 198 198 198 198 198 198 ...
##  $ dname  : chr  "it04" "it04" "it04" "it04" ...
##  $ cname  : chr  "Italy" "Italy" "Italy" "Italy" ...
##  $ iso2   : chr  "it" "it" "it" "it" ...
##  $ year   : num  2004 2004 2004 2004 2004 ...
##  $ wave   : num  6 6 6 6 6 6 6 6 6 6 ...
##  $ pwgt   : num  3.7 3.7 8.9 8.9 8.9 ...
##  $ ppopwgt: num  21820 21820 52526 52526 52526 ...</code></pre>
<p>So, now we have two tidy datas, <code>data_spss</code> and <code>meta_spss</code>, and we can use whatever methods we need to for analysing <code>data_spss</code>.</p>
</div>
<div id="labelling-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#labelling-the-data" class="anchor"></a>Labelling the data</h2>
<p>For labelling the data with the <code>meta_spss</code> we can use function <code>tidymwetadata::label_data()</code> that basically uses <code>match()</code> for mapping the numeric values with corresponding value labels. Below we are labeling the variable <code>sex</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss$sex_lab &lt;-<span class="st"> </span>tidymetadata::<span class="kw">label_data</span>(data_spss, 
                                               <span class="dt">variable.data =</span><span class="st">"sex"</span>, 
                                               <span class="dt">variable.meta =</span> <span class="st">"sex"</span>,
                                               <span class="dt">metadata=</span>meta_spss, 
                                               <span class="dt">into.factor=</span><span class="ot">FALSE</span>)

<span class="kw">head</span>(data_spss[<span class="kw">c</span>(<span class="st">"sex"</span>,<span class="st">"sex_lab"</span>)])</code></pre></div>
<pre><code>## # A tibble: 6 × 2
##     sex   sex_lab
##   &lt;dbl&gt;     &lt;chr&gt;
## 1     1   [1]male
## 2     2 [2]female
## 3     1   [1]male
## 4     2 [2]female
## 5     1   [1]male
## 6     1   [1]male</code></pre>
</div>
</div>
<div id="case-personal-net-hourly-wage-by-sex-and-education" class="section level1">
<h1 class="hasAnchor">
<a href="#case-personal-net-hourly-wage-by-sex-and-education" class="anchor"></a>Case: Personal net hourly wage by sex and education</h1>
<p>Lets then do a quick demo on how to use this package with a simple analysis that uses following variables:</p>
<ul>
<li>
<em>pmi</em> = <code>pmi</code>
</li>
<li>
<em>gender</em> = <code>sex</code>
</li>
<li>
<em>highest completed education level</em> = <code>educ</code>
</li>
</ul>
<p>Lets print the metadata out of those variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># re-creating metadata</span>
spss  &lt;-<span class="st"> </span><span class="kw">read_sav</span>(<span class="st">"./datasets/data.sav"</span>)
spss_meta &lt;-<span class="st"> </span><span class="kw">create_metadata</span>(spss)
meta_spss[meta_spss$code %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">"sex"</span>,<span class="st">"pmi"</span>,<span class="st">"educ"</span>),] %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">code</th>
<th align="left">name</th>
<th align="left">label</th>
<th align="right">value</th>
<th align="left">class</th>
<th align="left">type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[1]male</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">[2]female</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">[1]low</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">[2]medium</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">[3]high</td>
<td align="right">3</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">[9]all else</td>
<td align="right">9</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">pmi</td>
<td align="left">total income, person, monetary</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">numeric</td>
<td align="left">spss</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong></p>
<p><em>In this particular data they have added numeric prefixes for each value label to define the order of the levels. As it looks odd in the outputs, lets remove all with some reqular expression</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meta_spss$label &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">"^</span><span class="ch">\\</span><span class="st">[[0-9]+</span><span class="ch">\\</span><span class="st">]"</span>, <span class="st">""</span>, meta_spss$label)
<span class="co">#</span>
meta_spss[meta_spss$code %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">"sex"</span>,<span class="st">"pmi"</span>,<span class="st">"educ"</span>),] %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">code</th>
<th align="left">name</th>
<th align="left">label</th>
<th align="right">value</th>
<th align="left">class</th>
<th align="left">type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">male</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">sex</td>
<td align="left">gender</td>
<td align="left">female</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">low</td>
<td align="right">1</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">medium</td>
<td align="right">2</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">high</td>
<td align="right">3</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="even">
<td align="left">educ</td>
<td align="left">highest completed education level (3-category recode)</td>
<td align="left">all else</td>
<td align="right">9</td>
<td align="left">factor</td>
<td align="left">spss</td>
</tr>
<tr class="odd">
<td align="left">pmi</td>
<td align="left">total income, person, monetary</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">numeric</td>
<td align="left">spss</td>
</tr>
</tbody>
</table>
<p>To get started with the analysis, lets first compute the mean hourly wage for each category using the stripped data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(cname,sex,educ,pmi) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cname,sex,educ) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_wage =</span> <span class="kw">mean</span>(pmi)) -&gt;<span class="st"> </span>d_mean

<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(d_mean, <span class="kw">aes</span>(<span class="dt">x=</span>educ,<span class="dt">y=</span>mean_wage)) +<span class="st"> </span><span class="kw">geom_col</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~sex)</code></pre></div>
<p><img src="tidymetadata_tutorial_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
<p>Then lets label the variables before plotting it with <code>into.factor=FALSE</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(cname,sex,educ,pmi) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cname,sex,educ) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_wage =</span> <span class="kw">mean</span>(pmi)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"sex"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">FALSE</span>),
         <span class="dt">educ =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"educ"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">FALSE</span>)) -&gt;<span class="st"> </span>d_mean

<span class="kw">ggplot</span>(d_mean, <span class="kw">aes</span>(<span class="dt">x=</span>educ,<span class="dt">y=</span>mean_wage)) +<span class="st"> </span><span class="kw">geom_col</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~sex)</code></pre></div>
<p><img src="tidymetadata_tutorial_files/figure-html/unnamed-chunk-12-1.png" width="480"></p>
<p>With <code>into.factor</code> set as <code>FALSE</code> the value labels are put in place as character ie. without any order. When set <code>TRUE</code> the value labels are forced into factors with same order of value labels as in the original SPSS/Stata files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(cname,sex,educ,pmi) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cname,sex,educ) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_wage =</span> <span class="kw">mean</span>(pmi)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"sex"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>),
         <span class="dt">educ =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"educ"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>)) -&gt;<span class="st"> </span>d_mean

<span class="kw">ggplot</span>(d_mean, <span class="kw">aes</span>(<span class="dt">x=</span>educ,<span class="dt">y=</span>mean_wage)) +<span class="st"> </span><span class="kw">geom_col</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~sex)</code></pre></div>
<p><img src="tidymetadata_tutorial_files/figure-html/unnamed-chunk-13-1.png" width="480"></p>
<p>Package <a href="http://forcats.tidyverse.org/"><code>forcats</code></a> is useful when you need to do more adjusting for the factors, for instance reversing the order of the factor labels as below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(cname,sex,educ,pmi) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cname,sex,educ) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_wage =</span> <span class="kw">mean</span>(pmi)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"sex"</span>, 
                          <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>),
         <span class="dt">educ =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"educ"</span>, 
                           <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">sex  =</span> forcats::<span class="kw">fct_rev</span>(sex),
    <span class="dt">educ =</span> forcats::<span class="kw">fct_rev</span>(educ)
  ) -&gt;<span class="st"> </span>d_mean

<span class="kw">ggplot</span>(d_mean, <span class="kw">aes</span>(<span class="dt">x=</span>educ,<span class="dt">y=</span>mean_wage)) +<span class="st"> </span><span class="kw">geom_col</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~sex)</code></pre></div>
<p><img src="tidymetadata_tutorial_files/figure-html/unnamed-chunk-14-1.png" width="480"></p>
<div id="adding-new-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-new-variables" class="anchor"></a>Adding new variables</h2>
<p>You often need to create new variables when working with social surveys, this is how you would do for <code>age_class</code></p>
<p>First, lets make sure that variable ´age` is numeric with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meta_spss[meta_spss$code ==<span class="st"> "age"</span>,]$class ==<span class="st"> "numeric"</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>then classify it into four categories</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss$age_class[data_spss$age &lt;<span class="st"> </span><span class="dv">20</span>] &lt;-<span class="st"> </span><span class="dv">1</span>
data_spss$age_class[data_spss$age &gt;=<span class="st"> </span><span class="dv">20</span> &amp;<span class="st"> </span>data_spss$age &lt;<span class="st"> </span><span class="dv">40</span>] &lt;-<span class="st"> </span><span class="dv">2</span>
data_spss$age_class[data_spss$age &gt;=<span class="st"> </span><span class="dv">40</span> &amp;<span class="st"> </span>data_spss$age &lt;<span class="st"> </span><span class="dv">60</span>] &lt;-<span class="st"> </span><span class="dv">3</span>
data_spss$age_class[data_spss$age &gt;=<span class="st"> </span><span class="dv">60</span>] &lt;-<span class="st"> </span><span class="dv">4</span>
<span class="kw">as.data.frame</span>(<span class="kw">table</span>(data_spss$age_class))</code></pre></div>
<pre><code>##   Var1 Freq
## 1    1  190
## 2    2  285
## 3    3  445
## 4    4  438</code></pre>
<p>then lets add the new variable into metadata</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_row &lt;-<span class="st"> </span><span class="kw">data_frame</span>(
  <span class="dt">code =</span> <span class="st">"age_class"</span>,
  <span class="dt">name =</span> <span class="st">"age in four classes"</span>,
  <span class="dt">value =</span> <span class="dv">1</span>:<span class="dv">4</span>,
  <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">"under 25"</span>,
            <span class="st">"25 to 39"</span>,
            <span class="st">"40 to 59"</span>,
            <span class="st">"60 or more"</span>),
  <span class="dt">class=</span><span class="st">"factor"</span>
)
meta_spss &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(meta_spss,new_row)</code></pre></div>
<p>Lets add the age class dimension to our analysis from above</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_spss %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(cname,sex,educ,pmi,age_class) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cname,sex,educ,age_class) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_wage =</span> <span class="kw">mean</span>(pmi)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sex =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"sex"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>),
         <span class="dt">educ =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"educ"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>),
         <span class="dt">age_class =</span> <span class="kw">label_data</span>(.,<span class="dt">variable.data =</span> <span class="st">"age_class"</span>, <span class="dt">metadata =</span> meta_spss, <span class="dt">into.factor=</span><span class="ot">TRUE</span>)) -&gt;<span class="st"> </span>d_mean

<span class="kw">ggplot</span>(d_mean, <span class="kw">aes</span>(<span class="dt">x=</span>educ,<span class="dt">y=</span>mean_wage)) +<span class="st"> </span><span class="kw">geom_col</span>() +<span class="st"> </span><span class="kw">facet_grid</span>(age_class~sex)</code></pre></div>
<p><img src="tidymetadata_tutorial_files/figure-html/unnamed-chunk-18-1.png" width="480"></p>
<p>Again, this approach is very useful when working with shiny-applications as pointed out in this example at <a href="https://github.com/muuankarski/tidymetadata/tree/master/inst/shiny-examples/lisapp" class="uri">https://github.com/muuankarski/tidymetadata/tree/master/inst/shiny-examples/lisapp</a> that can be lauched with <code>tidymetadata::runExample()</code></p>
</div>
</div>
<div id="re-create-the-spss-data" class="section level1">
<h1 class="hasAnchor">
<a href="#re-create-the-spss-data" class="anchor"></a>Re-create the spss-data</h1>
<p>You can then re-create spss-data from stripped data &amp; meta-data using the following script</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#using-tidymetadata-package-with-luxembourdg-income-study-data">Using tidymetadata-package with Luxembourdg Income Study data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#download-spss-stata-and-sas-training-data-from-luxembourg-income-study">Download SPSS, Stata and SAS training data from Luxembourg Income Study</a></li>
      <li><a href="#create-tidy-metadata">Create “tidy metadata”</a></li>
      <li><a href="#stripping-data-from-attributes">Stripping data from attributes</a></li>
      <li><a href="#labelling-the-data">Labelling the data</a></li>
      </ul>
</li>
      <li>
<a href="#case-personal-net-hourly-wage-by-sex-and-education">Case: Personal net hourly wage by sex and education</a><ul class="nav nav-pills nav-stacked">
<li><a href="#adding-new-variables">Adding new variables</a></li>
      </ul>
</li>
      <li><a href="#re-create-the-spss-data">Re-create the spss-data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Markus Kainu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
